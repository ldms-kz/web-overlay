<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Управление матчем</title>
  <style>
    /* ... (стили остаются без изменений, см. предыдущую версию) ... */
  </style>
</head>
<body>
  <div class="controls">
    <h2>Панель управления</h2>
    <button class="close-btn" onclick="window.close()">Закрыть панель</button>

    <!-- ... (разделы команд, счёта, гола остаются без изменений) ... -->


    <div class="section">
      <h3>Таймер матча</h3>
      <div style="text-align: center; font-size: 24px; margin: 10px 0;" id="timer-display">00:00</div>
      <div style="display: flex; flex-wrap: wrap; gap: 10px;">
        <button onclick="startTimer()">Старт</button>
        <button onclick="pauseTimer()">Пауза</button>
        <button onclick="resetTimer()">Сброс</button>
        <button onclick="endMatch()">Матч окончен</button>
      </div>
    </div>
  </div>

  <script>
    // Получаем ссылку на оверлей
    const overlayWindow = window.opener;


    // Ключи для localStorage (совпадают с оверлеем)
    const SCORE_KEY = 'football_score';
    const TIMER_KEY = 'football_timer';
    const GOALS_KEY = 'football_goals';
    const TEAMS_KEY = 'football_teams';


    // Текущие данные (инициализируем из localStorage, если есть)
    let score = { team1: 0, team2: 0 };
    let timerSeconds = 0;
    let timerInterval = null;
    let isRunning = false;

    // Загрузка данных из localStorage
    function loadFromStorage() {
      const storedScore = localStorage.getItem(SCORE_KEY);
      if (storedScore) score = JSON.parse(storedScore);

      const storedTimer = localStorage.getItem(TIMER_KEY);
      if (storedTimer) timerSeconds = parseInt(storedTimer, 10);


      const storedTeams = localStorage.getItem(TEAMS_KEY);
      if (storedTeams) {
        const teams = JSON.parse(storedTeams);
        document.getElementById('team1-input').value = teams.team1;
        document.getElementById('team2-input').value = teams.team2;
      }
    }

    // Сохранение данных в localStorage
    function saveToStorage() {
      localStorage.setItem(SCORE_KEY, JSON.stringify(score));
      localStorage.setItem(TIMER_KEY, timerSeconds.toString());
    }

// Обработчик сообщений от оверлея (включая инициализацию)
window.addEventListener('message', (event) => {
  if (event.origin !== window.location.origin) return;


  const data = event.data;

  if (data.type === 'init-from-overlay') {
    // Инициализируем данные из оверлея
    score = data.data.score;
    timerSeconds = data.data.timerSeconds;


    document.getElementById('team1-input').value = data.data.teams.team1;
    document.getElementById('team2-input').value = data.data.teams.team2;


    updateTimerDisplay();
    document.getElementById('score-display').textContent = 
      `${score.team1} : ${score.team2}`;


    console.log('Панель инициализирована данными из оверлея');
    return;
  }

  // Остальные обработчики (как в исходном коде)
  if (data.type === 'initial-data') {
    score = data.score || { team1: 0, team2: 0 };
    timerSeconds = data.timerSeconds || 0;

    // ... (остальной код синхронизации)
  }
});
    
    // Отправка сообщений в оверлей
    function sendToOverlay(data) {
      if (!overlayWindow) {
        console.error('Оверлей не найден! Панель открыта неправильно.');
        return;
      }
      overlayWindow.postMessage(data, window.location.origin);
    }

    // ... (функции updateTeams, changeScore, addGoal остаются без изменений) ...


    // Таймер (исправлено: не зависит от состояния панели)
    function startTimer() {
      if (isRunning) return;
      isRunning = true;

      timerInterval = setInterval(() => {
        if (timerSeconds >= 5400) { // 90 минут
          pauseTimer();
          endMatch();
          return;
        }

        timerSeconds++;
        updateTimerDisplay();

        sendToOverlay({
          type: 'update-timer',
          seconds: timerSeconds
        });

        saveToStorage();
      }, 1000);
    }

    function pauseTimer() {
      clearInterval(timerInterval);
      isRunning = false;
    }

    function resetTimer() {
      pauseTimer();
      timerSeconds = 0;
      updateTimerDisplay();

      sendToOverlay({
        type: 'update-timer',
        seconds: 0
      });

      saveToStorage();
    }

    function endMatch() {
      pauseTimer();

      sendToOverlay({
        type: 'match-ended'
      });

      saveToStorage();
    }

    // Обновление отображения таймера
    function updateTimerDisplay() {
      const min = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
      const sec = (timerSeconds % 60).toString().padStart(2, '0');
      document.getElementById('timer-display').textContent = `${min}:${sec}`;
    }

    // Инициализация
    function init() {
      loadFromStorage();
      updateTimerDisplay();
      document.getElementById('score-display').textContent = 
        `${score.team1} : ${score.team2}`;

      // Запрашиваем актуальные данные у оверлея
      if (overlayWindow) {
        overlayWindow.postMessage({ type: 'request-initial-data' },
          window.location.origin);
      }
    }

    // Обработчик сообщений от оверлея (синхронизация при открытии панели)
    window.addEventListener('message', (event) => {
      if (event.origin !== window.location.origin) return;

      const data = event.data;

      if (data.type === 'initial-data') {
        score = data.score || { team1: 0, team2: 0 };
        timerSeconds = data.timerSeconds || 0;

        document.getElementById('team1-input').value = data.teams.team1;
        document.getElementById('team2-input').value = data.teams.team2;

        document.getElementById('score-display').textContent =
          `${score.team1} : ${score.team2}`;
        updateTimerDisplay();
      }
    });

    window.onload = init;
  </script>
</body>
</html>

